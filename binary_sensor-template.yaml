template:
  - binary_sensor:
    - name: Charge or not
      state: >-
        {% set charge_kw = 3.7 %}
        {% set battery_kwh = 69 %}
        {% set charge_limit = states.sensor.tesla_charge_limit_soc.state|int %} 
        {% set current_soc = states.sensor.tesla_battery_level.state|int %}
        {% set charge_hours = (( charge_limit - current_soc ) / 100 * battery_kwh / charge_kw)|round|int %}
        {%- set data = 
        state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_today')|selectattr('start', '>=', (now()))|sort(attribute='value') +
        state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_tomorrow')[:8]|rejectattr('value', 'eq', None)|list|sort(attribute='value')
        %}
        {%- set l=data|sort(attribute='value') %}
        {%- set ns = namespace(status=[]) %}
        {%- if l|list|count < charge_hours %}
           {%- set range_hours = l|list|count %}
         {%- else %}
           {%- set range_hours = charge_hours %}
        {%- endif %}
        {%- for i in range(range_hours) %}
          {% if l[i].start|string|as_timestamp | timestamp_custom("%Y-%m-%d %H", True, "%Y-%m-%d %H") == (now()|string)|as_timestamp | timestamp_custom("%Y-%m-%d %H", True, "%Y-%m-%d %H") %}
            {%- set ns.status = "yes" %}
          {%- endif %}
        {%- endfor %}
        {% if ns.status == "yes" %}
          True
        {% else %}
          False
        {% endif %}
